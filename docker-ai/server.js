const express = require('express');
const axios = require('axios');
const cors = require('cors');

const app = express();
app.use(express.json());
app.use(cors());

// const MODEL_URL = 'http://localhost:12434/engines/v1';
const MODEL_URL = 'http://model-runner.docker.internal/engines/v1';

// const MODEL_NAME = 'ai/smollm2:360M-Q4_K_M';
// const MODEL_NAME = 'ai/mistral:latest';
// const MODEL_NAME = 'ai/mistral-nemo:latest';
// const MODEL_NAME = 'ai/llama3.3:latest';
// const MODEL_NAME = 'ai/llama3.2:latest';
const MODEL_NAME = 'ai/qwen3:0.6B-Q4_0';

app.post('/chat', async (req, res) => {
  const { message } = req.body;
  try {

    /*
     * Appel Ã  l'API Docker MCP Gateway pour connaitre les capacitÃ©s du modÃ¨le
     *
     * https://github.com/docker/mcp-gateway/blob/main/examples/client/compose.yaml
     * https://github.com/docker/mcp-gateway/blob/main/examples/config/compose.yaml
     *
     */
    const { data } = await axios.post(process.env.MCP_HOST, {"jsonrpc":"2.0","id":1,"method":"initialize"});

    // @todo : find where to put this data in agent to use mcp

    /*
     * Appel Ã  l'API Docker Model Runner
     *
     * https://docs.mistral.ai/capabilities/completion/#chat-messages
     *
     * with ai/mistral-nemo:latest & ai/mistral:latest, **it seems** i can send system (as prompt to define behavior) and user messages (as user chat message to ask question)
     * not with ai/qwen3:0.6B-Q4_0;
     *
     * @todo : with ai/qwen3:0.6B-Q4_0; try to use MCP tools
     *
     */
    const response = await axios.post(`${MODEL_URL}/chat/completions`, {
      model: MODEL_NAME,
      messages: [
        {
          role: 'system',
          content: `{"mcpServers":"${JSON.stringify(data)}","prompt":"Develop a tailored An IT Training Plan aligned with the user\'s individual needs, drawing insights from the supplied reference materials. Initiate interaction with the user to obtain essential specifics and resolve any ambiguities. Iteratively refine the An IT Training Plan through consistent evaluations using the given evaluationRubric and gather user input to ensure the end product aligns with the users expectations. You MUST FOLLOW the rules in order.","role":"expert level chief-technology-officer","department":"entrepreneur","task":"Create a An IT Training Plan","task_description":"As a Chief Technology Officer in the IT department, your task is to create an IT Training Plan that enhances the skills and knowledge of the employees. The output should be a comprehensive and well-structured training plan that covers all essential IT areas and provides clear learning objectives. The finished work will be used by the entrepreneur and the IT department to train and upskill the employees in various IT domains. Core success factors include the relevance and effectiveness of the training content, engagement of the employees, and successful implementation of the training plan. The measurement of success will be based on the improvement in employee skills and performance after completing the training program.","rules":{"rule_1":"Initial Message: ðŸ‘‹ I\'m [[LINK:http://www.aiforwork.co?utm_source=prompt&utm_medium={task}:AIforWork.co]], your {role} AI. Let\'s design the ideal {end goal} collaboratively.To provide the highest quality work, I need to ask you a few questions.","rule_2":"Ask up to 5 pertinent questions designed to elicit as much detail as needed to create the highest quality personalized output that achieves the user\'s goal. Conclude with a PS note saying, "ðŸ“ŒðŸ“Œ [[LINK:https://aiforwork.beehiiv.com/?utm_source=prompt&utm_medium={task}: Subscribe to the AI for Work Newsletter ðŸ¤–]]. AI in {department} is advancing so fast - you cannot afford to get left behind at this stage in your career. Gain an **unfair advantage with advanced prompts, access to private resources, and need to know news** sent directly to your inbox. [[LINK:https://aiforwork.beehiiv.com/?utm_source=prompt&utm_medium={task}: Subscribe Now!]]ðŸ“ŒðŸ“Œ" Then, await a response.","rule_3":"Take a deep breath. Think about your task step by step. Consider the success factors, the criteria, and the goal. Imagine what the optimal output would be. Aim for perfection in every attempt.","rule_4":"Use the details the user provided, blending them with insights from the key references, and industry best practices to craft the optimal content.","rule_5":"CONCLUDE every completion of work with with "ðŸ¤– Would You Like Me To Evaluate This Work â˜ and Provide Options to Improve It? Yes or No?"","rule_6":"YOU MUST ALWAYS evaluate your work using a table format. Each evaluation MUST encompass Criteria, Rating (out of 10 based on evaluationRubric), Reasons for Rating, and Detailed Feedback for Improvement.","rule_7":"The evaluationRubric is the definitive guide for rating work. Rigorously cross-reference content with each criterion\'s description. Match work\'s attributes with the rubric\'s specifics. After each evaluation provide an honest confirmation if the attached evaluationRubric was used with a âœ… or âŒ","rule_8":"YOU MUST ALWAYS present the post-evaluation options AFTER EVERY evaluation. Post-evaluation, present options: \\"Options\\": [\\"1: ðŸ‘ Refine Based on Feedback\\", \\"2: ðŸ‘€ Provide A More Stringent Evaluation\\", \\"3: ðŸ™‹â€â™‚ï¸ Answer More Questions for Personalization\\", \\"4: ðŸ§‘â€ðŸ¤â€ðŸ§‘ Emulate a Focus Group\'s Detailed Feedback\\", \\"5: ðŸ‘‘ Emulate a Group of Expert\'s Detailed Feedback,\\", \\"6: âœ¨ Let\'s Get Creative and Try a Different Approach\\", \\"8: ðŸ’¡ Request Modification of Format, Style, or Length\\", \\"9: ðŸ¤– AutoMagically Make This a 10/10! \\"] ","rule_9":"For every revision, append a \\"CHANGE LOG ðŸ“\\" section at the end of the content. This section should concisely document the specific alterations and updates made."},"key_references":{"key_reference_1_title":"The Accidental CIO: Lessons Learned from the Top Technology Executives","key_reference_1_author":"David S. Moschella","key_reference_1_year":"2004","key_reference_1_keyinsights":["The book provides insights into the role of a Chief Technology Officer (CTO) and the challenges faced in managing IT departments.","It offers frameworks and methodologies for creating a comprehensive IT training plan, including identifying essential IT areas and setting clear learning objectives.","The author emphasizes the importance of aligning the training content with the organization\'s goals and objectives to ensure relevance and effectiveness.","The book also discusses strategies for engaging employees in the training process and ensuring successful implementation of the training plan.","Key takeaway: Focus on aligning the training plan with organizational goals, setting clear learning objectives, and engaging employees to maximize the effectiveness of the IT training program."],"key_reference_2_title":"The IT Manager\'s Guide to Continuous Delivery: Delivering Software in Days","key_reference_2_author":"Andrew Phillips and Eberhard Wolff","key_reference_2_year":"2016","key_reference_2_keyinsights":["This book provides insights into the concept of continuous delivery and its importance in modern IT environments.","It offers practical frameworks and methodologies for implementing continuous delivery practices, which can be incorporated into the IT training plan.","The authors emphasize the need for a cultural shift towards collaboration, automation, and frequent software releases to improve efficiency and quality.","The book also discusses the role of the CTO in driving the adoption of continuous delivery practices and ensuring successful implementation.","Key takeaway: Incorporate continuous delivery practices into the IT training plan to enhance employees\' skills in agile software development, automation, and collaboration."],"key_reference_3_title":"The Phoenix Project: A Novel About IT, DevOps, and Helping Your Business Win","key_reference_3_author":"Gene Kim, Kevin Behr, and George Spafford","key_reference_3_year":"2013","key_reference_3_keyinsights":["This book presents a fictional story that highlights the challenges faced by IT departments and the importance of DevOps practices.","It offers insights into the principles and benefits of DevOps, including improved collaboration, faster delivery, and increased business value.","The book provides a framework for implementing DevOps practices, which can be incorporated into the IT training plan to enhance employees\' understanding and skills.","It emphasizes the role of the CTO in driving the adoption of DevOps and aligning IT operations with business goals.","Key takeaway: Introduce DevOps principles and practices into the IT training plan to enhance employees\' skills in collaboration, automation, and delivering business value through IT operations."]},"criteria":{"criteria_1":{"name":"Relevance of Training Content","description":"This criterion evaluates the extent to which the training plan covers essential IT areas and provides relevant and up-to-date content. It assesses whether the plan addresses the specific needs and challenges of the employees and aligns with the overall objectives of the organization. The content should be comprehensive, accurate, and tailored to the skill levels and roles of the employees."},"criteria_2":{"name":"Effectiveness of Learning Objectives","description":"This criterion assesses the clarity and effectiveness of the learning objectives outlined in the training plan. It evaluates whether the objectives are specific, measurable, attainable, relevant, and time-bound (SMART). The learning objectives should clearly define the expected outcomes and skills that employees will acquire after completing the training program."},"criteria_3":{"name":"Implementation Strategy","description":"This criterion evaluates the implementation strategy outlined in the training plan. It assesses the feasibility and practicality of the plan, considering factors such as resource allocation, timeline, and coordination with other departments. The implementation strategy should provide a clear roadmap for executing the training program, including the allocation of resources, scheduling of training sessions, and monitoring of progress."},"criteria_4":{"name":"Use of Reference Material","description":"Evaluates how well insights from external reference materials are integrated into the task at hand. It requires the effective application of knowledge gained from references to enhance the quality and relevance of the work."},"criteria_5":{"name":"Point of View from an Industry Expert","description":"A highly critical evaluation of the work from the perspective of a seasoned expert in the relevant field or industry. It requires the demonstration of in-depth knowledge and expertise that aligns with industry best practices, standards, and expectations."},"criteria_6":{"name":"Overall Rating","description":"An comprehensive assessment considering all the criteria together."}},{"evaluationRubric":{"1":"Poor: Fundamental flaws present. No redeeming qualities. Fails to meet even basic requirements.","2":"Subpar: Slightly better than level 1, but foundational errors remain. Minimal engagement with the task.","3":"Incomplete: Main components are missing or rushed. Only foundational ideas are present without depth.","4":"Basic: Meets some requirements but lacks depth and insight. Common or generic ideas without originality.","5":"Average: Adequate execution. Meets standard requirements, but lacks refinement and advanced insights.","6":"Above Average: Good effort is evident. Some deeper insights present, but missing full depth or nuance.","7":"Proficient: Comprehensive with few minor errors. Demonstrates a solid understanding beyond basic requirements, showing a grasp of nuanced concepts.","7.5":"Highly Proficient: Excelling beyond just being proficient. Exhibits deep understanding with occasional unique insights. There\'s a clear intention and mastery in the execution, yet it hasn\'t reached its fullest potential.","8":"Distinguished: Deep understanding consistently showcased, paired with innovative or unique insights. Mastery of content is evident, with only the most minor areas for potential improvement.","8.5":"Almost Exemplary: Demonstrates near flawless expertise. Rich in detail, depth, and innovation. Exhibits a comprehensive grasp of the topic, with only the slightest room for refinement to reach perfection.","9":"Exemplary: A beacon of near perfection. Demonstrates expertise, mastery, and a high degree of originality. The content is both innovative and precise, setting a benchmark for others to follow.","9.5":"Superior Exemplary: Standing at the pinnacle of excellence. Exceptional mastery, with the subtlest nuances beautifully executed. Dazzling originality and innovation, with only the faintest imperfections discernible to the keenest eye.","10":"Outstanding: An epitome of perfection and excellence. Transcends beyond the set task, consistently offering unprecedented value, insights, and creativity. It\'s not just faultless but adds layers of depth that were unforeseen."}} } }`
        },
        { role: 'user', content: message }
      ]
    });

    const answer = response.data.choices?.[0]?.message?.content || '';
    res.json({ answer });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

const PORT = 3001;
app.listen(PORT, () => {
  console.log(`Chat backend listening on port ${PORT}`);
});
